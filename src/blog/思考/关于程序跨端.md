# 关于跨端

可以结合文章《JSBridge引发的思考》一起看
## 背景
* 为什么需要跨端？
一套代码跑多端，省时省力

## 小程序上层框架（跨APP）

简介：基于web技术的一套代码跑在各个APP小程序：微信/支付宝/抖音等
代表框架: taro（类React/Vue等语法，taro v3可以编译成RN）,uniapp（类Vue语法）

### 原理

* 代码执行：编译成各APP原生小程序代码后被原生小程序执行
* 视图渲染：类React/Vue模板**编译**（AST转换）成对应APP小程序模板树（例如：微信就是微信小程序模板），再被原生小程序渲染
* API层面：把各端API **proxy**成统一的API调用，最终还是执行原生小程序暴露的API

## 原生小程序（跨操作系统，双线程+1个native线程）

简介：基于web技术的一套代码跑在 IOS ，Android，开发者工具上
代表框架：微信小/支付宝等原生小程序

### 原理
* 运行环境：IOS-JavascriptCore-WKWebView，Android-V8-chromium内核，开发者工具-NWJS-chromeWebview
* 视图渲染：原生+webview混合（内置组件类型），模板会转为语法树，然后跟内置组件映射渲染
    * 使用原生组件的地方会被先用DOM节点占位，然后再用原生组件覆盖占位点
        * 问题：导致原生组件层级会更高？DOM样式没法应用上去？
        * 优势：体验更好（input键盘控制力；减轻webview渲染压力，比如map直接给原生线程渲染了）
* API（本地存储，网络请求等）：JSBridge
### 关于双线程
* 安全管控
    * 沙箱可控
    * 限制 DOM 和 BOM 能力
    * 各种API限制
* 性能（UI跟逻辑分离，互不阻塞）
* 引发的问题：逻辑层与渲染层之间通信延迟，异步->运行时序->生命周期（解决方案）
* 发展方向：提升通信速度？
* 天生延迟：由于是不同线程之前的调用，所以对原生API的调用也是异步，所以会出现各种callback？
## App（跨操作系统）
简介：基于或者不基于web技术的一套代码跑在IOS跟Android系统
代表框架：React Native（类React语法），Flutter（Dart widget）

### 原理
#### React Native（三线程）
* 代码执行：js代码交由JS Engine（JavascriptCore，Hermes，V8 etc）执行
* API调用（本地存储，定位，网络请求等）：Native <-> js代码通过**JSBridge**
* 视图渲染：通过 UI Manager 来创建视图的（基于 Virtual DOM ，RN 把不同平台创建视图的逻辑封装了一层，不同平台通过 Bridge 调用 UI Manager 来创建不同的 Native 视图）；所以依赖原生渲染层；（ps:在浏览器 JavaScript 可以调用 DOM API 完成创建 UI 的工作）

三线程
* JS thread： 负责 JS 和原生代码的交互线程，因为 JS 是单线程模型，所以需要一个单独的线程来驱动，并且 JS 和 Native 交互是异步的。
* Shadow thread: 这个线程是负责 Native 布局，提供给 yoga 引擎使用。
* UI thread：这个可以看作是主线程，可以看作是 UI Manager 线程，负责页面的交互和控件绘制逻辑。

总结：JIT模式，需要频繁地在JavaScript与Native之间进行通信，从而会有一定的性能损耗影响，导致体验上与原生会有一些差异。

***开发者编写的js代码，通过 react native 的中间层转化为原生控件和操作，Bridge 的作用就是给 React Native 内嵌的 JS Engine 提供原生接口的扩展供 JS 调用***

#### Flutter
重写了一整套包括底层渲染逻辑和上层开发语言的完整解决方案

* 代码执行：使用dart
    * dev需要flutter虚拟机 JIT？
    * prodution会AOT编译成原生
* API调用：dart可以AOT编译成平台原生代码，所以不需要bridge进行交互
* 视图渲染：flutter不使用平台原生控件（那是不是小程序/web这些端也能完美跨起来？），而是使用自身渲染引擎（skia）绘制widget（依赖平台的canvas能力）
# Reference
* [移动端跨平台开发的深度解析](https://juejin.cn/post/6844903630584152072)
* [RN原理分析](https://juejin.cn/post/6916452544956858382#heading-8)
* https://developers.weixin.qq.com/ebook?action=get_post_info&docid=0006a2289c8bb0bb0086ee8c056c0a
* https://wizardpisces.github.io/blog/JSbridge%E5%BC%95%E5%8F%91%E7%9A%84%E6%80%9D%E8%80%83

***本文属于个人的见解，酌情观看***